name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write
    pull-requests: read # Required for git-cliff to fetch PR information

jobs:
    build:
        name: Build ${{ matrix.platform }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - platform: x86_64-pc-windows-msvc
                      os: windows-latest
                      binary-suffix: .exe
                      archive-ext: .zip

                    - platform: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      binary-suffix: ""
                      archive-ext: .tar.gz

                    - platform: x86_64-apple-darwin
                      os: macos-15-intel
                      binary-suffix: ""
                      archive-ext: .tar.gz

                    - platform: aarch64-apple-darwin
                      os: macos-latest
                      binary-suffix: ""
                      archive-ext: .tar.gz

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform }}

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Build release binary
              run: cargo build --release --target ${{ matrix.platform }}

            - name: Package release archive
              shell: bash
              run: |
                  cp target/${{ matrix.platform }}/release/mergers${{ matrix.binary-suffix }} mergers${{ matrix.binary-suffix }}
                  if [[ "${{ matrix.archive-ext }}" == ".zip" ]]; then
                    7z a mergers-${{ matrix.platform }}.zip mergers.exe
                  else
                    tar czf mergers-${{ matrix.platform }}.tar.gz mergers
                  fi

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: mergers-${{ matrix.platform }}${{ matrix.archive-ext }}
                  path: mergers-${{ matrix.platform }}${{ matrix.archive-ext }}

    changelog:
        name: Generate Release Notes
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')
        outputs:
            release_body: ${{ steps.git-cliff.outputs.content }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect revert pairs
              id: reverts
              run: |
                  SKIP_FLAGS=$(bash scripts/find-revert-pairs.sh)
                  echo "flags=${SKIP_FLAGS}" >> "$GITHUB_OUTPUT"

            - name: Generate release notes
              uses: orhun/git-cliff-action@v4
              id: git-cliff
              with:
                  config: cliff.toml
                  args: ${{ steps.reverts.outputs.flags }} --latest --strip header
              env:
                  GITHUB_REPO: ${{ github.repository }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    release:
        name: Create Release
        needs: [build, changelog]
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Create release
              uses: softprops/action-gh-release@v2
              with:
                  files: artifacts/mergers-*/mergers-*
                  body: ${{ needs.changelog.outputs.release_body }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
